## note





### 文档



ES 面向文档，文档是最小可搜索单元。

文档以 JSON 为序列化方式，每个文档都由 UniqueId。

Mappingf  Setring

文档原数据：

- _index
- _id
- _type
- _source
- _version
- _score



![image-20210411215817799](/home/chen/_note/pic/image-20210411215817799.png)



### 节点类型

Master-eligibe 和 Miaster Node

Master-eligibe 可以参与选举，是起始状态，经过选举就变成了 Master 节点，

只有 Master 可以修改集群内容。

Data Node 数据节点，负责保存分片数据。

Coordinating Node 候选人节点，负责接收请求，分发到合适节点并汇总，每个节点默认为该类型。



### 分片

主分片，用于解决数据水平扩展问题，和副本(主分片的拷贝)。



### 倒排索引

1. 单词词典

   ​	保存文档所有的单词，记录单词到倒排列表的关联关系。

2. 倒排列表

   ​	倒排索引项目。



JSON 文档每个字段都有自己的倒排索引。



### 分词器 Analyzer

![image-20210413221959831](/home/chen/_note/pic/image-20210413221959831.png)

![image-20210413222012083](/home/chen/_note/pic/image-20210413222012083.png)

> Es 中的分词器包括的三部分组件：
>
> 1. Character Filters
> 2. Tokenizer
> 3. Token Filters



> Character Filters 在 Tokenizer 之前对文本进行处理，增加删除或替换字符，可以配置多个。
>
> 如果说 Tokenizer 是 Servlet，那么 Character Filters 当然是 Filter。
>
> 一些自带的 Character Filters：
>
> 1. HTML strip  -  去除 HTML 标签
> 2. Mapping  -  字符串映射替换
> 3. Pattern replace   -  正则替换



> Tokenizer 将文本按照规则切分为词（Term or token）

![image-20210416000739379](/home/chen/_note/pic/image-20210416000739379.png)

> Token Filters 是在 Tokenizer 输出的单词进行修改

![image-20210416000725132](/home/chen/_note/pic/image-20210416000725132.png)





> 自定义分词器的试验:

![image-20210416001409573](/home/chen/_note/pic/image-20210416001409573.png)



> 自定义 Mapping 中的分词器：

```json
PUT INDEX_NAME
{
    "settings":{
        "analysis":{
            "analyzer":
        }
    }
}
```





![image-20210413222046844](/home/chen/_note/pic/image-20210413222046844.png)

![image-20210413222148929](/home/chen/_note/pic/image-20210413222148929.png)





### 查询

![image-20210413223441455](/home/chen/_note/pic/image-20210413223441455.png)

![image-20210413223957195](/home/chen/_note/pic/image-20210413223957195.png)

![image-20210415233916957](/home/chen/_note/pic/image-20210415233916957.png)

Mapping 相当于数据库的表结构定义。

![image-20210415234020677](/home/chen/_note/pic/image-20210415234020677.png)

![image-20210415234032289](/home/chen/_note/pic/image-20210415234032289.png)

根据插入和修改自动推断字段类型。

![image-20210415234311636](/home/chen/_note/pic/image-20210415234311636.png)

> 可以设置索引的 dynamic 属性，true，false，strict

![image-20210415234716977](/home/chen/_note/pic/image-20210415234716977.png)



通过 PUT 显示定义 Mapping:

```json
PUT chen
{
	"mappints":{
		// Mapping 的定义格式
	}
}
```

> Mapping 中的相关属性：

1. index 

index 为 false 表示字段不需要被索引，也就无法被搜索。

```json
PUT chen
{
	"mappints":{
		// Mapping 的定义格式
        "properties": {
            "firstName":{
                "type": "int",
                "index": false 
            }
        }
	}
}
```

2. index_options

![image-20210415235148684](/home/chen/_note/pic/image-20210415235148684.png)



3. null_value

![image-20210415235248631](/home/chen/_note/pic/image-20210415235248631.png)

为空使用 null_value 替换原空值，用来对空值进行查询。

4. copy_to

混合多字段产生一个虚拟可查询字段。

5. 数组类型

Es 中不需要显式定义一个数组，text 类型的字段也能支持存放数组



![image-20210415235900782](/home/chen/_note/pic/image-20210415235900782.png)

![image-20210415235944060](/home/chen/_note/pic/image-20210415235944060.png)

Es 中区分精确值和全文本，精确值就是 keyword，对于 Keyword  来说一定程度上不会进行分词处理。