# 数据库事务相关



## 数据库事务特性

数据库的特性有如下四种，**原子性（Atomicity），一致性（Consistency），隔离性（Isolation），持久性（Durability）**。



原子性指的是事务的操作作为一个不可再分的整体，要不同时完成要不同时失败，不会存在部分成功部分失败的情况。

> 这和 Redis 的事务有点出入，Redis 中的事务实现并不会在失败时回滚。

一致性指的是事务执行的前后，数据库中的数据都处于一种稳定状态。(emmm.. 我也不是特别了解)

隔离性指的是多个事务并发执行的时候，互相之间的可见性。

持久性好理解，就是保证数据的持久，不丢失，在事务提交之后，事务造成的变更就是永久性的。





## InnoDB 中 ACID 的实现

首先是原子性，InnoDB 中使用 undo 段保存了所有操作的 undo 日志，在事务回滚的时候直接执行 undo 日志就可以恢复到执行前的状态。

一致性... emmm 不太清楚。

**隔离性，InnoDB 的隔离性是依靠 MVCC 和 锁来实现的。**

InnoDB 中提供了多种不同的隔离级别，不同的隔离级别都有不同的锁和 MVCC 表现形式来支持隔离性。

持久性，InnoDB 中的持久性是依靠的 redo log 以及 undo log 实现的。

> 并说不清为什么还需要 undo log，但是因为 WAL 机制，redo log 是在数据修改前就已经持久化的，在事务提交的时候可以保证 redo log 已经落盘了，大部分情况下 redo log 就已经能保障数据的持久性了。







### 隔离级别

MySQL 中提供了四种隔离级别

- READ UNCOMMITTED 读未提交
- READ COMMITED 读已提交
- REPEATABLE READ 可重复读
- SERIALIZABLE  序列化



四种隔离级别分别解决了不同的并发问题：

| 隔离解别            | 脏读 | 不可重复读 | 幻读 |
| ------------------- | ---- | ---------- | ---- |
| Read Uncommitted    | Y    | Y          | Y    |
| Read Committed      | N    | Y          | Y    |
| Repeatable(default) | N    | N          | Y    |
| Serializable        | N    | N          | N    |

> 简单理解一下这三种并发问题：
>
> 脏读，事务读取到了其它事务中未提交的数据。
>
> 不可重复读，事务前后多次读取内容不一致。
>
> 幻读，事务前后多次读取总量不一致。



RC  解决脏读依靠的就是锁和MVCC。

> MVCC 在 InnoDB 的 RR 和 RC 级别下表现是不一样的，RR 级别下，MVCC 以第一次 SELECT 查到的数据为主不会再创建新的快照，但是 RC 级别下，MVCC 机制每次都会创建新的快照，所以也会存在前后数据不一致的情况。





## MVCC 多版本并发控制

MVCC 在我看来是 InnoDB 中一个非常重要的特性，极大的提高了 MySQL 的并发性能。

MVCC 就是多版本并发控制，也就是常说的快照读，在 InnoDB 中，一行数据可能会保存多个版本，也就是多个快照。

> 这里多个版本的保存依靠的就是 undo log，所以 undo log 是 MVCC 的实现基础。

不同的事务进来的时候看到的是不同版本的数据，区分开之后对事务的查询基本不需要上锁，非常高效。



InnoDB 的行记录包含了两个隐藏列，保存了创建的事件以及创建的事务Id。

MySQL 的事务创建时都会向系统申请一个事务Id，这个Id单调递增且不重复。

> ！！！事务创建是以第一次查询为准，而非 start tran。

事务开始时，会主动创建一个数组，包含了以下三个部分：

​     **已提交的事务     |     正在执行的事务     |     未开始的事务     |**

根据以上的数组，每个事务都能确定自己的可见性。



**MVCC 特性仅仅在 RC 和 RR 级别下生效，**并且在两个级别下的表现形式不同。

在 RC 级别下，每次查询都会创建一个快照，而在 RR 级别下，只有第一次查询会创建一个快照。

> 这就导致了事务的表现不同。
>
> 在 RC 级别下，事务可以查看到别的事务已经提交的数据，这样就造成了不可重复读，也无法避免脏读。
>
> 而在 RR 级别下，事务只会以第一次查询语句为准创建快照，所以 RR 级别下不会出现所谓的不可重复读问题。



 