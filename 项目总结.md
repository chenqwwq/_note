# 面试复习

## 项目整理

### 响应

#### 定时消息模块

需求背景：

学校不希望家长在上课时间给学生发消息，但又不能让家长一直等着，所以有该功能，家长可以以五分钟为跨度指定发送时间。

包括发送消息，取消发送，修改发送时间，立即发送等接口。

##### 功能实现

实现上采用的是 Redis 的 ZSET/SET 结构和 XXL-JOB 的分片广播。

不考虑 RabbitMQ 的延时消息的原因是延时的精度不够，即使安装插件也无法满足取消发送等需求。

本地队列考虑到消息在宕机时的失效。

<br>

具体实现在 ZSET 的基础上，创建8个 ZSET 分片，所有的消息根据 RelateId 作为分片键，决定投递到哪个 ZSET。

ZSET 只保存 发送时间 -> RelateId  的映射关系，而具体需要发送的消息保存在额外的 SET 结构中，因为会话中可能存在多条定时消息，或者双方都能发定时消息，此时就需要保证定时消息的有序，所以同个会话的消息需要一起处理。

XXL-JOB 采用分片广播的形式，根据分片信息调度节点负责的 ZSET，进行发送。

在节点宕机之后可以根据分片信息作容错，将 ZSET 分配给别的节点。

<br>

#### 聊天记录同步模块

需求背景：

有一些应用可能会需要在响应中的转发数据做一些其他需求，例如资源中心需要依据转发来做权限扩展，没问于写作需要根据转发来确定美文的阅读来源。


##### 功能实现

服务端发消息的时候提供一个 Oid（outId），表示外部 Id，每个应用都会分配固定的前缀。

发送消息的时候如果 Oid 不为空，则使用异步的 EventBus 进行调度，包装为 MsgRecordEvent，取出 oid 和 消息之后直接扔入到处理链中。

使用模板方法模式 + 责任链模式实现整个的处理链，不同的应用需要不同的同步方式，资源中心需要使用接口形式，而错题本，美文与写作不需要即时性的应用采用 MQ 的形式推送。

使用模板方法模式时，抽取出的是 RabbitMQ 的发送逻辑，需要延时发送，以及接口的调用形式，支持多条记录同时同步。

责任链中包含 support 方法判断是否可以在当前类中处理，处理完成之后退出。

<br>

还有就是批量的问题，集齐100条记录或者 5s 之内未同步的时候进行一次同步方法的调用。

刚开始使用的相同的一个记录延时聚合的实现，后来 MQ 自己有 Batch 方法之后，只有接口调用需要使用延时聚合的工具类。

维护一个当前的时间戳。

<br>


#### 多渠道的消息推送

需求背景：

接入自研的推送系统以及个推系统，使用个推是因为有家长端的存在，需要对接多厂商渠道（苹果有自己的官方推送，但是国内禁了 Google，所以只能接各个厂商各自的通道。

此处对 Google 的 EventBus 进行了改造。

<br>

#### 会话并发更新处理

表结构中每一个私聊会话对应着两条会话记录，在一次消息发送的流程中需要先后更新双方的会话，所以会出现死锁的情况。

> 死锁的出现是因为双方不可撤回的争用，默认的双方的更新是先更新自己的会话，在更新对方的会话，所以会有争用造成死锁的问题。
>
> MySQL 在检测到死锁的时候会直接回滚其中一个 SQL，MySQL 使用的有向无环图来检测死锁。

为了消除死锁，所以采用了但SQL联合更新的方式，因为在同一个事务之内所以一条还是两条SQL没有影响，并且采用 in 查询更新时，先对用户 id 进行升序排列，相同顺序的更新只会导致等待，而不是死锁。



、



## 述职

家长端留言消息

重构消息推送模块（

