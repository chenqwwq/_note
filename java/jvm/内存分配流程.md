# Java 虚拟机的内存分配流程

---

[TOC]

---



start 表示对象的创建，类似 new Object()。

![JVM 的内存分配流程](assets/webp)



是否栈上分配需要考虑是否有引用逃逸（逃逸分析技术），分析过后如果没有逃逸现象，那么可以做以下优化：

- **标量替换**，将一个完整的对象分散为几个标量，标量可以简单理解为原始数据类型。
- **同步消除（锁消除）**，只被一个线程访问，所以该变量的同步可以消除。
- **栈上分配**，因为栈的对象随着出栈自动清理，所以栈上分配可以减少 GC 的压力。

对象首先尝试在 Eden 分配内存，不过为了避免多线程的内存争用，每个线程都有自己的 TLAB （Thread Local Allocation Buffer，默认仅仅占 Eden 区的1%，使用 ）。

| 参数                      | 作用                       | 默认值   |
| ------------------------- | -------------------------- | -------- |
| -XX:UseTLAB               | 是否开启线程本地内存缓冲区 | 默认开启 |
| -XX:TLABSize              | 缓冲区大小                 |          |
| -XX:+EliminateAllocations | 是否开启标量替换           | 默认开启 |



**上图涉及的是内存分配的流程，如果是 new 方法流程，那就需要从 ClassLoader 开始说起。**